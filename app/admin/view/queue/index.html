{extend name='table'}

{block name="button"}
<!--{if isset($super) and $super}-->
<a class="layui-btn layui-btn-sm layui-btn-primary" data-queue="{:url('admin/api.plugs/optimize')}">优化数据库</a>
{if $iswin}
<button data-load='{:url("admin/api.queue/start")}' class='layui-btn layui-btn-sm layui-btn-primary'>开启后台服务</button>
<button data-load='{:url("admin/api.queue/stop")}' class='layui-btn layui-btn-sm layui-btn-primary'>关闭后台服务</button>
{/if}
<!--{/if}-->

<!--{if auth("clean")}-->
<button data-queue='{:url("clean")}' class='layui-btn layui-btn-sm layui-btn-primary'>定时清理数据</button>
<!--{/if}-->

<!--{if auth("remove")}-->
<button data-action='{:url("remove")}' data-rule="id#{id}" data-table-id="QueueData" data-confirm="确定批量删除记录吗？" class='layui-btn layui-btn-sm layui-btn-primary'>批量删除任务</button>
<!--{/if}-->
{/block}

{block name="content"}
<div class="think-box-notify">
    <b>任务统计：</b>待处理 {$total.pre|default=0} 个任务，处理中 {$total.dos|default=0} 个任务，待处理 {$total.oks|default=0} 个任务，已失败 {$total.ers|default=0} 个任务。
</div>
<div class="think-box-shadow">
    {include file='queue/index_search'}
    <table id="QueueData" data-url="{:sysuri()}" data-target-search="form.form-search"></table>
</div>
{/block}

{block name='script'}
<style>
    #QueueData + div tbody .layui-table-cell {
        height: 42px;
        line-height: 22px;
    }

    #QueueData + div tbody .layui-table-cell .layui-btn {
        margin-top: 8px;
    }

    #QueueData + div tbody .layui-table-cell.laytable-cell-checkbox {
        line-height: 42px;
    }
</style>
<script>
    $(function () {
        $('#QueueData').layTable({
            height: 'full',
            even: true, sort: {field: 'loops_time desc,id', type: 'desc'},
            cols: [[
                {checkbox: true, fixed: 'left'},
                {
                    field: 'id', title: '任务名称', minWidth: 230, sort: true, templet: function (d) {
                        if (d.loops_time > 0) {
                            d.one = '<span class="layui-badge think-bg-blue">循</span>';
                        } else {
                            d.one = '<span class="layui-badge think-bg-red">次</span>';
                        }
                        if (d.rscript === 1) {
                            d.two = '<span class="layui-badge layui-bg-green">复</span>';
                        } else {
                            d.two = '<span class="layui-badge think-bg-violet">单</span>';
                        }
                        return laytpl('{{d.one}}任务编号：<b>{{d.code}}</b><br>{{d.two}}任务名称：{{d.title}}').render(d);
                    }
                },
                {
                    field: 'exec_time', title: '任务计划', minWidth: 300, templet: function (d) {
                        d.html = '执行指令：' + d.command + '<br>计划执行：' + d.exec_time;
                        if (d.loops_time > 0) {
                            return d.html + ' ( 每 <b class="color-blue">' + d.loops_time + '</b> 秒 ) ';
                        } else {
                            return d.html + ' <span class="color-desc">( 单次任务 )</span> ';
                        }
                    }
                },
                {
                    field: 'loops_time', title: '执行状态', width: 400, templet: function (d) {
                        d.html = [
                            '<span class="layui-badge layui-badge-middle layui-bg-gray pull-left" style="width:2em">未知</span>',
                            '<span class="layui-badge layui-badge-middle layui-bg-black pull-left" style="width:2em">等待</span>',
                            '<span class="layui-badge layui-badge-middle layui-bg-blue pull-left" style="width:2em">执行</span>',
                            '<span class="layui-badge layui-badge-middle layui-bg-green pull-left" style="width:2em">完成</span>',
                            '<span class="layui-badge layui-badge-middle layui-bg-red pull-left" style="width:2em">失败</span>',
                        ][d.status] || '';
                        d.html += '执行时间：';
                        d.enter_time = d.enter_time || '', d.outer_time = d.outer_time || '0.0000';
                        if (d.enter_time.length > 12) {
                            d.html += d.enter_time.substring(12) + '<span class="color-desc"> ( 耗时 ' + d.outer_time + ' )</span>';
                            d.html += '，已执行 <b>' + (d.attempts || 0) + '</b> 次';
                        } else {
                            d.html += '<span class="color-desc">任务未执行</span>'
                        }
                        return d.html + '<br>执行结果：<span class="color-blue">' + (d.exec_desc || '-') + '</span>';
                    }
                },
                {toolbar: '#toolbar', title: '操作面板', align: 'center', minWidth: 200}
            ]]
        });
    });
</script>

<script type="text/html" id="toolbar">

    <!--{if auth('redo')}-->
    {{# if(d.status===4||d.status===3){ }}
    <a class="layui-btn layui-btn-sm" data-confirm="确定要重置该任务吗？" data-queue="{:url('redo')}?code={{d.code}}">重 置</a>
    {{# }else{ }}
    <a class="layui-btn layui-btn-sm layui-btn-disabled">重 置</a>
    {{# } }}
    <!--{/if}-->

    <!--{if auth('remove')}-->
    <a class='layui-btn layui-btn-sm layui-btn-danger' data-confirm="确定要删除该任务吗？" data-action='{:url("remove")}' data-value="id#{{d.id}}">删 除</a>
    <!--{/if}-->

    <a class='layui-btn layui-btn-sm layui-btn-normal' onclick="$.loadQueue('{{d.code}}',false,this)">日 志</a>
</script>
{/block}
